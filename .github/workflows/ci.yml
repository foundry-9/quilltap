name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: npx next build
        env:
          # Skip lint during build since we already ran it
          SKIP_ENV_VALIDATION: true
          ENCRYPTION_MASTER_PEPPER: 'test-pepper-for-ci-environment-32chars!'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next
            !.next/cache
          retention-days: 1

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check if tests exist
        id: check-tests
        run: |
          if [ -d "__tests__" ] && [ "$(find __tests__ -name '*.test.ts' -o -name '*.test.tsx' -o -name '*.test.js' -o -name '*.test.jsx' | wc -l)" -gt 0 ]; then
            echo "tests_exist=true" >> $GITHUB_OUTPUT
            echo "âœ… Tests found"
          else
            echo "tests_exist=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No tests found in __tests__ directory"
          fi

      - name: Run tests with coverage
        if: steps.check-tests.outputs.tests_exist == 'true'
        run: npm run test:coverage
        env:
          ENCRYPTION_MASTER_PEPPER: 'test-pepper-for-ci-environment-32chars!'

      - name: Report test status
        if: steps.check-tests.outputs.tests_exist == 'false'
        run: |
          echo "::warning::No tests found to run. Consider adding tests to improve code quality."
          echo "ðŸ“ To add tests, create test files in the __tests__ directory"

      - name: Generate coverage report
        if: steps.check-tests.outputs.tests_exist == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage
          retention-days: 30

      - name: Coverage Summary
        if: steps.check-tests.outputs.tests_exist == 'true'
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            node -e "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              console.log('| Metric | Coverage |');
              console.log('|--------|----------|');
              console.log(\`| Lines | \${total.lines.pct}% (\${total.lines.covered}/\${total.lines.total}) |\`);
              console.log(\`| Statements | \${total.statements.pct}% (\${total.statements.covered}/\${total.statements.total}) |\`);
              console.log(\`| Functions | \${total.functions.pct}% (\${total.functions.covered}/\${total.functions.total}) |\`);
              console.log(\`| Branches | \${total.branches.pct}% (\${total.branches.covered}/\${total.branches.total}) |\`);
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "No coverage summary generated" >> $GITHUB_STEP_SUMMARY
          fi

  report:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, build, test]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result == 'success' && 'âœ… Passed' || needs.test.result == 'skipped' && 'âš ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" != "success" ] || [ "${{ needs.build.result }}" != "success" ] || [ "${{ needs.test.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **CI Pipeline Failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All CI checks passed!**" >> $GITHUB_STEP_SUMMARY
          fi
