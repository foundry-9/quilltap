#!/bin/bash

# Pre-commit hook to run lint, tests, and set version based on branch:
# - release branch: x.y.z
# - main branch: x.y.z-dev.[n] where n = commits since base version
# - other branches: x.y.z-[branch-name].[n]

set -e  # Exit on any error

echo "ðŸ” Running pre-commit checks..."
echo ""

# Step 1: Run linting
echo "ðŸ“‹ Step 1/3: Running ESLint..."
if ! npm run lint; then
  echo ""
  echo "âŒ Linting failed! Please fix the errors before committing."
  echo "   You can run 'npm run lint:fix' to auto-fix some issues."
  echo "   Or use 'git commit --no-verify' to skip this check (not recommended)."
  exit 1
fi
echo "âœ… Linting passed!"
echo ""

# Step 2: Build
echo "ðŸ—ï¸ Step 2/3: Building the project..."
if ! npm run build; then
  echo ""
  echo "âŒ Build failed! Please fix the errors before committing."
  exit 1
fi
echo "âœ… Build passed!"
echo ""

# Step 3: Run tests
echo "ðŸ§ª Step 3/3: Running tests..."
if ! npm test -- --passWithNoTests; then
  echo ""
  echo "âŒ Tests failed! Please fix the failing tests before committing."
  echo "   You can run 'npm test' to see the failures."
  echo "   Or use 'git commit --no-verify' to skip this check (not recommended)."
  exit 1
fi
echo "âœ… Tests passed!"
echo ""

# Step 3: Calculate version based on branch
echo "ðŸ“¦ Calculating version..."

# Detect OS for sed compatibility
if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS
  SED_INPLACE=(-i '')
else
  # Linux
  SED_INPLACE=(-i)
fi

# Get the current version from package.json (strip any suffix to get base x.y.z)
CURRENT_VERSION=$(grep -m1 '"version"' package.json | sed 's/.*"\([^"]*\)".*/\1/')
BASE_VERSION=$(echo "$CURRENT_VERSION" | sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/')

# Get the current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Count commits since the base version was set
# We look for the most recent commit that changed the base version (x.y.z part)
# by finding when package.json version line was changed to current base
COMMIT_COUNT=$(git rev-list --count HEAD -- . 2>/dev/null || echo "0")

# Try to find when the base version was last changed
BASE_VERSION_COMMIT=$(git log --oneline -p package.json 2>/dev/null | grep -B 50 "\"version\": \"$BASE_VERSION" | grep -m1 "^[a-f0-9]" | cut -d' ' -f1 || echo "")
if [ -n "$BASE_VERSION_COMMIT" ]; then
  COMMIT_COUNT=$(git rev-list --count "$BASE_VERSION_COMMIT"..HEAD 2>/dev/null || echo "0")
fi

# Determine the new version based on branch
if [[ "$CURRENT_BRANCH" == "release" || "$CURRENT_BRANCH" == release/* ]]; then
  # Release branch: just x.y.z
  NEW_VERSION="$BASE_VERSION"
  BADGE_COLOR="green"
elif [[ "$CURRENT_BRANCH" == "main" ]]; then
  # Main branch: x.y.z-dev.[n]
  NEW_VERSION="$BASE_VERSION-dev.$COMMIT_COUNT"
  BADGE_COLOR="yellow"
else
  # Feature/other branches: x.y.z-[branch-name].[n]
  # Sanitize branch name (replace / with -)
  SANITIZED_BRANCH=$(echo "$CURRENT_BRANCH" | sed 's/\//-/g')
  NEW_VERSION="$BASE_VERSION-$SANITIZED_BRANCH.$COMMIT_COUNT"
  BADGE_COLOR="yellow"
fi

# Update package.json with the new version
sed "${SED_INPLACE[@]}" -E "s/\"version\": \"[^\"]+\"/\"version\": \"$NEW_VERSION\"/" package.json

# Update README.md with the new version in the badge
if [ -f README.md ]; then
  # Replace any version number in the badge with the new version and color
  sed "${SED_INPLACE[@]}" -E "s/version-[^-]+-[^-]+-(green|yellow)/version-$NEW_VERSION-$BADGE_COLOR/" README.md
fi

# Check if package-lock.json exists and update it as well
if [ -f package-lock.json ]; then
  npm install --package-lock-only
fi

# Bump versions for plugins
if [ -f ./plugins/dist/qtap-plugin-template/schemas/plugin-manifest.json ]; then
  npm run generate:schemas
  npm run build:plugins
  git add ./plugins/dist/qtap-plugin-template/schemas/plugin-manifest.json
  git add ./plugins
fi

# Stage the updated package files
git add package.json
if [ -f package-lock.json ]; then
  git add package-lock.json
fi
if [ -f README.md ]; then
  git add README.md
fi

echo "âœ… Version set: $NEW_VERSION (base: $BASE_VERSION, branch: $CURRENT_BRANCH)"
echo ""
echo "âœ¨ All pre-commit checks passed!"

exit 0
