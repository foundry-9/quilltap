#!/bin/bash

# Pre-commit hook to run lint, tests, and automatically bump the patch version in package.json

set -e  # Exit on any error

echo "ğŸ” Running pre-commit checks..."
echo ""

# Step 1: Run linting
echo "ğŸ“‹ Step 1/2: Running ESLint..."
if ! npm run lint; then
  echo ""
  echo "âŒ Linting failed! Please fix the errors before committing."
  echo "   You can run 'npm run lint:fix' to auto-fix some issues."
  echo "   Or use 'git commit --no-verify' to skip this check (not recommended)."
  exit 1
fi
echo "âœ… Linting passed!"
echo ""

# Step 2: Run tests
echo "ğŸ§ª Step 2/2: Running tests..."
if ! npm test -- --passWithNoTests; then
  echo ""
  echo "âŒ Tests failed! Please fix the failing tests before committing."
  echo "   You can run 'npm test' to see the failures."
  echo "   Or use 'git commit --no-verify' to skip this check (not recommended)."
  exit 1
fi
echo "âœ… Tests passed!"
echo ""

# Step 3: Bump version
echo "ğŸ“¦ Bumping version..."

# Get the current version from package.json
CURRENT_VERSION=$(grep -m1 '"version"' package.json | sed 's/.*"\([^"]*\)".*/\1/')

# Split the version into major, minor, and patch
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

# Increment the patch version
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

# Detect OS for sed compatibility
if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS
  SED_INPLACE=(-i '')
else
  # Linux
  SED_INPLACE=(-i)
fi

# Update package.json with the new version
sed "${SED_INPLACE[@]}" "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"$NEW_VERSION\"/" package.json

# Check if package-lock.json exists and update it as well
if [ -f package-lock.json ]; then
  sed "${SED_INPLACE[@]}" "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"$NEW_VERSION\"/" package-lock.json
fi

# Stage the updated package files
git add package.json
if [ -f package-lock.json ]; then
  git add package-lock.json
fi

echo "âœ… Version bumped: $CURRENT_VERSION â†’ $NEW_VERSION"
echo ""
echo "âœ¨ All pre-commit checks passed!"

exit 0
