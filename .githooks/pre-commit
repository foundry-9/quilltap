#!/bin/bash

# Pre-commit hook to run lint, tests, and automatically bump the patch version in package.json

set -e  # Exit on any error

echo "ğŸ” Running pre-commit checks..."
echo ""

# Step 1: Run linting
echo "ğŸ“‹ Step 1/3: Running ESLint..."
if ! npm run lint; then
  echo ""
  echo "âŒ Linting failed! Please fix the errors before committing."
  echo "   You can run 'npm run lint:fix' to auto-fix some issues."
  echo "   Or use 'git commit --no-verify' to skip this check (not recommended)."
  exit 1
fi
echo "âœ… Linting passed!"
echo ""

# Step 2: Build
echo "ğŸ—ï¸ Step 2/3: Building the project..."
if ! npm run build; then
  echo ""
  echo "âŒ Build failed! Please fix the errors before committing."
  exit 1
fi
echo "âœ… Build passed!"
echo ""

# Step 3: Run tests
echo "ğŸ§ª Step 3/3: Running tests..."
if ! npm test -- --passWithNoTests; then
  echo ""
  echo "âŒ Tests failed! Please fix the failing tests before committing."
  echo "   You can run 'npm test' to see the failures."
  echo "   Or use 'git commit --no-verify' to skip this check (not recommended)."
  exit 1
fi
echo "âœ… Tests passed!"
echo ""

# Step 3: Bump version
echo "ğŸ“¦ Bumping version..."

# Get the current version from package.json
CURRENT_VERSION=$(grep -m1 '"version"' package.json | sed 's/.*"\([^"]*\)".*/\1/')

# Split the version into major, minor, and patch
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

# Increment the patch version
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

# Detect OS for sed compatibility
if [[ "$OSTYPE" == "darwin"* ]]; then
  # macOS
  SED_INPLACE=(-i '')
else
  # Linux
  SED_INPLACE=(-i)
fi

# Update package.json with the new version
sed "${SED_INPLACE[@]}" "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"$NEW_VERSION\"/" package.json

# Update README.md with the new version in the badge
if [ -f README.md ]; then
  # Determine badge color based on branch
  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
  if [[ "$CURRENT_BRANCH" == "release"* ]]; then
    BADGE_COLOR="green"
  else
    BADGE_COLOR="yellow"
  fi

  # Replace any version number in the badge with the new version and color
  sed "${SED_INPLACE[@]}" -E "s/version-[0-9]+\.[0-9]+\.[0-9]+-(green|yellow)/version-$NEW_VERSION-$BADGE_COLOR/" README.md
fi

# Check if package-lock.json exists and update it as well
if [ -f package-lock.json ]; then
  npm install --package-lock-only
fi

# Bump versions for plugins
if [ -f ./plugins/dist/qtap-plugin-template/schemas/plugin-manifest.json ]; then
  npm run generate:schemas
  npm run build:plugins
  git add ./plugins/dist/qtap-plugin-template/schemas/plugin-manifest.json
  git add ./plugins
fi

# Stage the updated package files
git add package.json
if [ -f package-lock.json ]; then
  git add package-lock.json
fi
if [ -f README.md ]; then
  git add README.md
fi

echo "âœ… Version bumped: $CURRENT_VERSION â†’ $NEW_VERSION"
echo ""
echo "âœ¨ All pre-commit checks passed!"

exit 0
