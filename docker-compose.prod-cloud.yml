version: '3.8'

# Production Docker Compose configuration for Quilltap with external services
# Uses MongoDB Atlas for database and AWS S3 for file storage
# All configuration is provided via environment variables

services:
  app:
    # Build from the existing Dockerfile with production target
    build:
      context: .
      dockerfile: Dockerfile
      target: production

    # Always restart the container unless explicitly stopped
    restart: always

    # Expose the Next.js application port
    ports:
      - "3000:3000"

    # Environment variables for external services integration
    environment:
      # Data backend configuration
      DATA_BACKEND: mongodb
      MONGODB_URI: ${MONGODB_URI}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-quilltap}

      # S3 external service configuration
      S3_MODE: external
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET:-quilltap-files}
      S3_PUBLIC_URL: ${S3_PUBLIC_URL}

      # Authentication configuration
      NEXTAUTH_URL: ${NEXTAUTH_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}

      # Encryption configuration
      ENCRYPTION_MASTER_PEPPER: ${ENCRYPTION_MASTER_PEPPER}

      # OAuth provider configuration
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}

    # Health check configuration
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Connect to the application network
    networks:
      - quilltap-network

networks:
  # Bridge network for container communication
  quilltap-network:
    driver: bridge
